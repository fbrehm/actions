---

name: "Building OS packages of a Python source package."

################################################################################
# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      debian_email:
        description: 'The mail address of the user, which will be used to update debian/chagelog.'
        type: string
        default: 'frank@brehm-online.com'
      debian_fullname:
        description: 'A human readable name of the user, which will be used to update debian/chagelog.'
        type: string
        default: 'Frank Brehm'
      has_i18n:
        description: 'Does the package support localisation and internationalisation?'
        type: boolean
        default: true
      languages:
        description: 'A list of languages, which will be supported, if has_i18n is true.'
        type: string
        default: '["de_DE.UTF-8", "en_US.UTF-8"]'
      test_python_versions:
        description: 'A list of Python versions, for which the package should be tested.'
        type: string
        default: '["3.6", "3.7", "3.8", "3.9", "3.10", "3.11", "3.12"]'
      latest_python_version:
        description: "The latest Python version for executing linter tests."
        type: string
        default: "3.12"
      libdir:
        description: "The directory in the workdir where the Python modules are located."
        type: string
        required: true
      additional_files_flake8:
        description: "Files or directories to check with flake8 additional to standard files and directories."
        type: string
      additional_scripts_shellcheck:
        description: "Files or directories to check with shellcheck additional to standard files and directories."
        type: string
      additional_paths_yamllint:
        description: "Files or directories to check with yamllint additional to standard files and directories."
        type: string
      retention_days:
        description: "The days for keeping the generated packages at GitHub."
        type: number
        default: 8
      latest_debian_version:
        description: 'The short name of the latest stable Debian version.'
        type: string
        default: 'bookworm'
      debian_versions:
        description: 'Whitespace separated list of Debian and Ubuntu version to build the package for.'
        type: string
        default: 'debian-bullseye debian-bookworm debian-trixie ubuntu-focal ubuntu-jammy ubuntu-noble'
    secrets:
      pypi_token:
        description: "The token to use for transmitting the package to PyPi"

################################################################################
env:
  DEBFULLNAME: ${{ inputs.debian_fullname }}
  DEBEMAIL: ${{ inputs.debian_email }}

################################################################################
jobs:

  ###########################
  exec-pytest:
    name: "Execute Python tests"
    uses: ./.github/workflows/exec-python-tests.yaml
    with:
      has_i18n: ${{ inputs.has_i18n }}
      languages: ${{ inputs.languages }}
      test_python_versions: ${{ inputs.test_python_versions }}

  ###########################
  exec-python-linter:
    name: "Exec linter checks on Python sources"
    uses: ./.github/workflows/python-linter-tests.yaml
    needs:
      - exec-pytest
    with:
      latest_python_version: ${{ inputs.latest_python_version }}
      libdir: ${{ inputs.libdir }}
      additional_files_flake8: ${{ inputs.additional_files_flake8 }}
      additional_scripts_shellcheck: ${{ inputs.additional_scripts_shellcheck }}
      additional_paths_yamllint: ${{ inputs.additional_paths_yamllint }}

  ###########################
  deploy-to-pypi:
    name: "Building the Python packages and deploying it to PyPi."
    uses: ./.github/workflows/deploy-to-pypi.yaml
    needs:
      - exec-python-linter
    with:
      latest_python_version: ${{ inputs.latest_python_version }}
      retention_days: ${{ inputs.retention_days }}
    secrets:
      pypi_token: ${{ secrets.pypi_token }}

  ###########################
  build-debian-packages:
    name: "Building Debian packages."
    uses: ./.github/workflows/build-python-debian-packages.yaml
    needs:
      - exec-pytest
    with:
      debian_email: ${{ inputs.debian_email }}
      debian_fullname: ${{ inputs.debian_fullname }}
      has_i18n: ${{ inputs.has_i18n }}
      languages: ${{ inputs.languages }}
      latest_debian_version: ${{ inputs.latest_debian_version }}
      debian_versions: ${{ inputs.debian_versions }}

# vim: et tabstop=2 expandtab shiftwidth=2 softtabstop=2 list
